{% extends 'base.html' %}
{% block link_and_script_in_head %}
<link rel="stylesheet" href="https://snipp.ru/cdn/jqueryui/1.12.1/jquery-ui.min.css">
<link rel="stylesheet" href="https://snipp.ru/cdn/jQuery-Timepicker-Addon/dist/jquery-ui-timepicker-addon.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
{% endblock %}
{% block tittle %}
Запись
{% endblock %}
{% load static %}
{% block content %}
<style type="text/css">
  :root {
      --td-textColor: #555555;
      --td-backgroundColor: #FFF;
      --td-primaryColor: #6E99FF;
      --td-displayBackgroundColor: #FFF;
      --td-displayBorderColor: #6E99FF50;
      --td-displayBorderStyle: solid;
      --td-displayBorderWidth: 4px;
      --td-handsColor: #6E99FF50;
      --td-handleColor: #6E99FF;
      --td-handlePointColor: white;
  }
  .td-select:after {
    display: none;
  }
</style>
{% include 'records/includes/switcher.html' %}
<div class="container_for_record">
  <div class="flex_record">
    <a class="back_to_calendar" href="{% url 'records:index_records' project %}?{{prev_month}}">
      <img src="{% static 'img/arroy-left.png' %}" height="35" width="35" alt="Предыдущий месяц">
      <span class="text_for_record_head but_for_back_calendar" id="prev_of_month">
        
      </span>
    </a>
    <a href="{% url 'records:index_records' project %}?{{ month_now_for_url }}">
      <span class="text_for_record_head but_for_back_calendar" id="name_of_month">
        Вернуться обратно в
      </span>
    </a>
    <a class="back_to_calendar" href="{% url 'records:index_records' project %}?{{ next_month }}">
      <span class="text_for_record_head but_for_back_calendar" id="next_of_month">
        
      </span>
      <img src="{% static 'img/arroy-right.png' %}" height="35" width="35" alt="Следующий месяц">
    </a>
  </div>
  <div class="week_name">
    <span class="week_name_text"> пн </span>
    <span class="week_name_text"> вт </span>
    <span class="week_name_text"> ср </span>
    <span class="week_name_text"> чт </span>
    <span class="week_name_text"> пт </span>
    <span class="week_name_text"> сб </span>
    <span class="week_name_text"> вс </span>
  </div>
  <div class="week_day">
    <div class="left">
      <img id="prev_img" class="card-img my-2" style="transform: rotate(180deg);" src="{% static 'img/arrow-point.png' %}" width="75px" height="75px" alt="Предыдущая неделя">
    </div>
    <div class="flex_week">
      {% for day_cart in week_line %}
        {{day_cart|safe}}
      {% endfor %}
    </div>
    <div class="right">
      <img id="next_img"  class="card-img my-2" src="{% static 'img/arrow-point.png' %}" width="75px" height="75px" alt="Следующая неделя">
    </div>
  </div>
  <span class="text-center text_for_record_head">
    Запись на транспортное средство "{{services.name_project}}"
  </span>
  <span class="records_start_text">
    {{date_str}}
  </span>
  <div class="card_to_main_form">
    {% if not error and not old_date and not many_rec %}
      <span class="text_free_time_to_record">
        Запись доступна с {{time_now_to_rec}} до {{services.high_time}}
      </span>
    {% endif %}
    {% if error or old_date or many_rec %}
    <h2 class="text-center">
      {{error}}
      {{old_date}}
      {{many_rec}}
    </h2>
    {% if not old_date %}
    {% if not many_rec %}
    <div class="form_main">
      <a href="{% url 'records:records_start' project date %}" class="btn btn-primary">
        Начать заново
      </a>
    </div>
    {% endif %}
    {% endif %}
    <div class="form_main">
      <a href="{% url 'records:index_records' project %}" class="btn btn-primary">
        На главную
      </a>
    </div>
    {% endif %}
    {% if form.errors %}
    {% for field in form %}
    {% for error in field.errors %}            
    <div class="alert alert-danger error_left" style="text-align: center">
      {{ error|escape }}
    </div>
    {% endfor %}
    {% endfor %}
    {% for error in form.non_field_errors %}
    <div class="alert alert-danger error_left" style="text-align: center">
      {{ error|escape }}
    </div>
    {% endfor %}
    {% endif %}
    <form method="post">
      {% csrf_token %}
      <div class="form_main">
        {% for field in form %}
          {{ field.errors }}
          <div class="text_center_for_phone">
            {{ field.label_tag }} {{ field }}
          </div>
        {% endfor %}
      </div>
      {% if not error and not old_date and not many_rec %}
      <div class="form_main">
        <button type="submit" class="button_for_main_form" id="disable_or_not">
          <span class="text_button">Записаться</span>
        </button>
      </div>
      {% endif %}
    </form>
    {% if not error and not old_date and not many_rec %}
    <div id="slider-range"></div>
    {% endif %}
    {{color_table|safe}}
    <div class="card_record">
      <span class="card_record_text">Записи</span>
    </div>
    <div class="record_card_yes_or_not">
      {% if ride_rec %}
      <table border="0" cellpadding="0" cellspacing="0" class="table table-hover table_record">
      {{ ride_rec|safe }}
      </table>
      {% else %}
      {{ ride_rec_empty|safe }}
      {% endif %}
    </div>
  </div>
</div>
{% endblock %} 
{% block script %}
<script src="https://snipp.ru/cdn/jquery/2.1.1/jquery.min.js"></script>
<script src="https://snipp.ru/cdn/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://snipp.ru/cdn/jQuery-Timepicker-Addon/dist/jquery-ui-timepicker-addon.min.js"></script>
<script src="https://code.jquery.com/jquery-1.12.1.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script src="{% static 'js/timedropper-jquery.js' %}"></script>
<script>
if( screen.width <= 1023 ) {
  $( document ).ready(function(){
    $('#id_start_time').timeDropper({
      format: 'HH:mm',
      minutesSteps: 5,
      customClass: 'picker2'
    });
    $('#id_end_time').timeDropper({
      format: 'HH:mm',
      minutesSteps: 5
    });
  });
}
</script>
<script>
  const arr_month = {
    '1': 'Январь',
    '2': 'Февраль',
    '3': 'Март',
    '4': 'Апрель',
    '5': 'Май',
    '6': 'Июнь',
    '7': 'Июль',
    '8': 'Август',
    '9': 'Сентябрь',
    '10': 'Октябрь',
    '11': 'Ноябрь',
    '12': 'Декабрь',
  };
  const prev_of_month = document.querySelector("#prev_of_month")
  const next_of_month = document.querySelector("#next_of_month")
  const name_of_month = document.querySelector("#name_of_month")
  let name_month = {{ month_now }}
  name_of_month.textContent += arr_month[name_month]
  if (name_month == 1) {
    prev_of_month.textContent += arr_month['12']
  }
  else {
    prev_of_month.textContent += arr_month[name_month-1]
  }
  if (name_month == 12) {
    next_of_month.textContent += arr_month['1']
  }
  else {
    next_of_month.textContent += arr_month[name_month+1]
  }

  const project = {{project}}
  let date_str = new String ({{date}})
  let dateNow = date_str.slice(0,4) + '-' + date_str.slice(4,6) + '-' + date_str.slice(6,8);

  function addDays() {
    var result = new Date(dateNow);
    result.setDate(result.getDate() + 7);
    dateNow = result;
  }

  function remDays() {
    var result = new Date(dateNow);
    result.setDate(result.getDate() - 7);
    dateNow = result;
  }

  function getWeek (remOrAdd=true) {
    if (remOrAdd == true) {
      addDays()
    }
    else {
      remDays()
    }
    let date_future = dateNow.toISOString().split('T')[0].replace('-', '').replace('-', '')
    const yourUrl = `http://84.201.173.5/api/get_week/${date_future}/${project}`
    var xhr = new XMLHttpRequest();
    xhr.open("GET", yourUrl);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.send();
    xhr.onreadystatechange = function() {
      if (xhr.readyState != 4) {
        return
      }
      if (xhr.status === 200) {
        let week_line_pass = document.querySelector(".flex_week")
        let del_el = document.querySelectorAll('.flex_week a');
        for (let element of del_el) {
          element.remove();
        }

        let json_week = JSON.parse(xhr.responseText).week_line
        let array_day_in_week = json_week.replace('[', '').replace(']', '').replace("'", '').split(', ')

        for (let i=0; i < 7; i++) {
          var wrapper = document.createElement('div');
          wrapper.innerHTML= array_day_in_week[i].replace("'", "").replace(">'", "");
          var div = wrapper.firstChild;
          wrapper.className = "width_230"
          week_line_pass.appendChild(wrapper);
        }

      } else {
        console.log('err', xhr.responseText)
      }
    }
  }

  let next_week = document.querySelector('#next_img');
  let prev_week = document.querySelector('#prev_img');
  next_week.addEventListener('click', getWeek())
  prev_week.addEventListener('click', getWeek(false))





  let list_rec_start = []
  let list_rec_end = []
  {% for rec in record_list_for_line %}
    list_rec_start.push(time_step("{{rec.start_time}}"))
    list_rec_end.push(time_step("{{rec.end_time}}"))
  {% endfor %}

  let dateNowReverse = date_str.slice(6,8) + '-' + date_str.slice(4,6) + '-' + date_str.slice(0,4);
  let today = new Date();
  let dd = String(today.getDate()).padStart(2, '0');
  let mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
  let yyyy = today.getFullYear();
  today = dd + '-' + mm + '-' + yyyy;
  let timeNow = new Date().toLocaleTimeString().slice(0,-3)

  let disable_or_not = document.querySelector("#disable_or_not")

  function jsValidate (values, list_rec_start, list_rec_end) {
    for (let i=0; i<list_rec_start.length; i++) {
      if (String(today) == String(dateNowReverse)) {
        if (values[0] <= time_step(String(timeNow))) {
          createError("Выберите корректное время")
          break
        }
        else {
          deleteError()
        }
      }
      if ((values[0] >= list_rec_start[i] && values[1] <= list_rec_end[i]) || (values[0] > list_rec_start[i] && values[0] < list_rec_end[i] && values[1] > list_rec_end[i])) {
        createError()
        break
      }
      else if (values[0] <= list_rec_start[i] && values[1] >= list_rec_end[i]) {
        createError()
        break
      }
      else if (values[0] < list_rec_start[i] && values[1] <= list_rec_start[i]) {
        deleteError()
      }
      else if (values[0] < list_rec_start[i] && values[1] <= list_rec_end[i]) {
        createError()
        break
      }
      else {
        deleteError()
      }
    }
  }

  function createError (text="К сожалению выбранное время уже занято") {
    if (document.querySelector("#error_js") == null) {
      disable_or_not.disabled = true
      disable_or_not.style["background"] = "rgba(0, 0, 0, 0.2)"
      let error = document.createElement('div');
      error.className = "alert"
      error.id = "error_js"
      error.className += " alert-danger"
      error.style["text-align"] = "center"
      error.style["height"] = "5%"
      error.style["position"] = "absolute"
      error.style["top"] = "1%"
      error.style["right"] = "5%"
      error.style["margin"] = "0"
      error.style["display"] = "flex"
      error.style["align-items"] = "center"
      error.textContent = text
      document.querySelector(".card_to_main_form").insertBefore(error, document.querySelector("form"))
    }
    else {
      return true
    }
  }

  function deleteError () {
    if (document.querySelector("#error_js") != null) {
      disable_or_not.disabled = false
      disable_or_not.style["background"] = "rgba(45, 129, 171, 1)"
      let elem = document.querySelector("#error_js")
      elem.remove()
      return true
    }
  }





  let counter = 0
  const firstMiddleTime = {{get_int_high_time}} - {{get_int_low_time}}
  let constYesOrNo = false
  let finalTime = [{{get_int_low_time}}, {{get_int_high_time}}]

  function getLowTimeToUnloadFirst() {
    const timeArray = getMiddleTime()
    let startMiddleTime = timeArray[0]
    let endMiddleTime = timeArray[1]
    let notCheck = false

    for (let i=0; i<list_rec_start.length; i++) {
      if ((startMiddleTime >= list_rec_start[i] && endMiddleTime <= list_rec_end[i]) || (startMiddleTime > list_rec_start[i] && startMiddleTime < list_rec_end[i] && endMiddleTime > list_rec_end[i])) {
        notCheck = true
        getLowTimeToUnloadFinal()
      }
      else if (startMiddleTime <= list_rec_start[i] && endMiddleTime >= list_rec_end[i]) {
        notCheck = true
        getLowTimeToUnloadFinal()
      }
      else if (startMiddleTime < list_rec_start[i] && endMiddleTime <= list_rec_start[i]) {
        continue
      }
      else if (startMiddleTime < list_rec_start[i] && endMiddleTime <= list_rec_end[i]) {
        notCheck = true
        getLowTimeToUnloadFinal()
      }
      else {
        continue
      }
    }
    if (notCheck == false) {
      finalTime = [startMiddleTime, endMiddleTime]
    }
  }

  function getMiddleTime(time=firstMiddleTime) {
    let counterTime = 0
    if (counter != 0 && (counter % 2) == 1) {
      counterTime = counter * 1
    }
    else {
      counterTime = counter * -1
    }
    counter += 1
    let middlTime = time / 100 * (50 + counterTime)
    let startMiddleTime = middlTime - 12
    let endMiddleTime = middlTime + 12
    let finalArrayMiddleTime = [Math.round(startMiddleTime), Math.round(endMiddleTime)]
    return finalArrayMiddleTime
  }

  function getLowTimeToUnloadFinal() {
    if (counter <= 40) {
      const timeArray = getMiddleTime()
      let startMiddleTime = timeArray[0]
      let endMiddleTime = timeArray[1]
      for (let i=0; i<list_rec_start.length; i++) {
        if ((startMiddleTime >= list_rec_start[i] && endMiddleTime <= list_rec_end[i]) || (startMiddleTime > list_rec_start[i] && startMiddleTime < list_rec_end[i] && endMiddleTime > list_rec_end[i])) {
          getLowTimeToUnloadFinal()
        }
        else if (startMiddleTime <= list_rec_start[i] && endMiddleTime >= list_rec_end[i]) {
          getLowTimeToUnloadFinal()
        }
        else if (startMiddleTime < list_rec_start[i] && endMiddleTime <= list_rec_start[i]) {
          continue
        }
        else if (startMiddleTime < list_rec_start[i] && endMiddleTime <= list_rec_end[i]) {
          getLowTimeToUnloadFinal()
        }
        else {
          continue
        }
      }
      if (constYesOrNo == false) {
        constYesOrNo = true
        finalTime = [startMiddleTime, endMiddleTime]
      }
    }
  }
  if (String(today) == String(dateNowReverse)) {
    finalTime = [Math.round(time_step(String(timeNow))), {{get_int_high_time}}]
  }
  else {
    getLowTimeToUnloadFirst()
  }


  function time_step(time) {
    time_full = time.split(":")
    time_hours = time_full[0]
    time_minuts = time_full[1]
    int_time = Number(time_hours) * 12 + Number(time_minuts) / 5;
    return int_time;
  }

  function time_hour(val){
    if (val < 120){
      return '0' + (val - val % 12) / 12;
    }
    else{
      return (val - val % 12) / 12;
    }
  }
    function time_minute(val){
      if ((val % 12) == (0) || (val % 12) == (1)) {
        return '0' + (val % 12) * 5;
      }
      else{
        return (val % 12) * 5;
      }
  }

  if( screen.width >= 1023 ) {
    $(document).ready(function(){
      $( "#slider-range" ).slider({
        range: true,
        min: {{get_int_low_time}},
        max: {{get_int_high_time}},
        values: [ finalTime[0], finalTime[1] ],
        slide: function( event, ui ) {
          $("#id_start_time").val(time_hour(ui.values[0])+":"+time_minute(ui.values[0]));
          $("#id_end_time").val(time_hour(ui.values[1])+":"+time_minute(ui.values[1]));
          jsValidate(ui.values, list_rec_start, list_rec_end)
        }
      });
    });
  }
  document.getElementById('id_start_time').value = time_hour(finalTime[0])+":"+time_minute(finalTime[0]);
  document.getElementById('id_end_time').value = time_hour(finalTime[1])+":"+time_minute(finalTime[1]);
</script>
{% endblock %}